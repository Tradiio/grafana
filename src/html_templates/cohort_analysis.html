<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="html_templates/templates.css">
<script type"text/javascript" src="html_templates/utils.js"></script>
</head>
<body>

<table id = "$panel.id$.cohort" class="stats" align="center">
    <thead>
      <th>Date</th>
      <th># Users</th>
    </thead>
</table>

<script>

function addPercentSpan(str){

  if (!isNaN(str)) return '<br><span class="percent_span">' + str  + '%' + '</span>';
  else             return '';
}

function getColor(val){

  // if      (val >= 75) return '#26AFDA';
  // else if (val >= 50) return '#2094B7';
  // else if (val >= 25) return '#1A718C';
  // else if (val >   0) return '#134F63';
  // else                return '#0D2C37';

  if      (val >= 75) return '#DA5126';
  else if (val >= 50) return '#B74320';
  else if (val >= 25) return '#8C351A';
  else if (val >   0) return '#632713';
  else                return '#37180D';

  // if      (val >= 75) return '#3F636A';
  // else if (val >= 50) return '#3C4D51';
  // else if (val >= 25) return '#323A3B';
  // else if (val >   0) return '#272A2B';
  // else                return '#212323';
}

function getTable(behaviour) {

  var gameDatasource       = $var-gameDatasource$;
  var analyticsDatasource  = $var-analyticsDatasource$;

  switch (behaviour){
    case 'all':
      return {"table" : "nysa.api.users.active.count.1d.distinct", "datasource" : gameDatasource, "key" : "distinct"};
      break;
    case 'sign_up':
      return {"table" : "nysa.api.users.registered.count", "datasource" : analyticsDatasource, "key" : "user_id"};
      break;
    default:
      return {"table" : "nysa.api.events." + behaviour + ".count.1d.distinct", "datasource" : gameDatasource, "key" : "distinct"}; 
  }
}

require(['../config.js'], function(Settings){

  var startDate            = $var-startDate$;
  var timespan             = $var-timespan$;
  var initialBehaviour     = $var-initialBehaviour$;
  var nextBehaviour        = $var-nextBehaviour$;

  var initialTable         = getTable(initialBehaviour);
  var nextTable            = getTable(nextBehaviour);

  var dates = datesBetween(timespan, startDate);
  var start = dates[0].str;
  var initialQuery = "select * from " + initialTable.table + " where time > '" + start + "' order asc";
  var nextQuery    = "select * from " + nextTable.table    + " where time > '" + start + "' order asc";

  var initialData   = getInfluxDbData(initialQuery, initialTable.datasource, Settings);
  var nextData      = getInfluxDbData(nextQuery, nextTable.datasource, Settings);

  var initialGroup = groupByTime(dates, initialData, initialTable.key);
  var nextGroup    = groupByTime(dates, nextData, nextTable.key);

  var table  = document.getElementById("$panel.id$.cohort"); 
  var header = table.tHead.children[0];
  var maxPerformance = 0;

  for (var i = 0; i < dates.length; i++) {
    var row            = table.insertRow(i+1);
    var dateCell       = row.insertCell(0);
    var initCell       = row.insertCell(1);
    var group          = initialGroup[dates[i].str];
    
    dateCell.innerHTML = dates[i].str;
    initCell.innerHTML = group.length;
    initCount          = group.length;

    if (i < dates.length - 1) {
      th = document.createElement('th');
      th.innerHTML = i + 1;
      header.appendChild(th);
    }

    for (var j = i+1; j < dates.length; j++) {
      var index         = j-i;
      var cell          = row.insertCell(index+1);
      var subGroup      = intersect(group, nextGroup[dates[j].str]);
      var perf          = Number(performance(subGroup.length, initCount));
      if (!isNaN(perf) && perf > maxPerformance) maxPerformance = perf;
      cell.innerHTML    = subGroup.length + addPercentSpan(performance(subGroup.length, initCount));
    }
  }

  $("#$panel.id$\\.cohort span").each(function() {

    var span = $(this)[0];
    var perf = Number(span.innerHTML.split("%")[0]);
    if (!isNaN(perf)){
      span.parentNode.style.backgroundColor = getColor(performance(perf, maxPerformance));
    }
  });

});

</script>

</body>
</html>
