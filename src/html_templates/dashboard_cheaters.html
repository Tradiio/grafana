<!DOCTYPE html>
<html>
<style type="text/css">
  table.scorecard {
    margin-left:auto; 
    margin-right:auto;
    font-size:13px;
    border-width: 1px;
    border-collapse: collapse;
  }
  table.scorecard td {
    border-width: 1px;
    padding: 8px;
    font-size: 14px;
    text-align: center;
    border-style: solid transparent;
  }

  table.stats {
    margin-left:auto; 
    margin-right:auto;
    font-size:13px;
    border-width: 1px;
    border-collapse: collapse;
  }
  table.stats td {
    border-width: 1px;
    padding: 5px;
    font-size: 14px;
    text-align: center;
    border-style: solid;
  }
  table.stats th {
    padding: 7px;
  }
  .timespan {
  	font-size: 12px;
  	color: #666;
    text-align: center;
  }
</style>
<script type"text/javascript" src="html_templates/utils.js"></script>
</head>
<body>

<p>Cheaters Dashboard</p>

<script>

function is_object(mixed_var) {
  if (Object.prototype.toString.call(mixed_var) === '[object Array]') {
    return false;
  }
  return mixed_var !== null && typeof mixed_var == 'object';
}

function merge(a, b, operator) {

  var cache = {};
  cache = unpackObject(a, cache, operator);
  cache = unpackObject(b, cache, operator);

  return cache;
}

function unpackObject(a, cache, operator) {
  for (prop in a) {
    if (a.hasOwnProperty(prop)) {
      if (cache[prop] === undefined) {
        cache[prop] = a[prop];
      } else {
        if (typeof cache[prop] === typeof a[prop]) {
          if (is_object(a[prop])) {
            cache[prop] = merge(cache[prop], a[prop]);
          } else {
            eval('cache[prop] ' + operator + '= a[prop]');
          }
        }
      }
    }
  }
  return cache;
}

function performance(a, b){

	return (a/b * 100).toFixed(1);
}

function addTimeSpan(str){
	return '<br><span class="timespan">' + str + '</span>';
}

function getInfluxDbData(query, datasource, settings){

  var username    = settings.datasources[datasource].username;
  var password    = settings.datasources[datasource].password;
  var url         = settings.datasources[datasource].url;

  var getUrl      = url + '/series?q=' + query + '&u=' + username + '&p=' + password;
  var result;

  $.ajax({

    url: getUrl,
    async: false,  
    success: function (data) {
      result = arrangeInfluxDbData(data);
    }
  });

  return result;
}

function arrangeInfluxDbData(data) {

  data     = data[0];
  points   = data['points'];
  columns  = data['columns'];

  result = _.map(points, function(value, key){
    var obj = {};

    for (var i = 0; i < value.length; i++){
      obj[columns[i]] = value[i];
    }

    return obj;
  });

  return result;
}

function getArtistArray(songs){

  var artists = {};

  for (var i = 0; i < songs.length; i++){
    artists[songs[i].song_id] = songs[i].artist_id;
  }

  return artists;
}

function groupByKey(array, key){

  // [] or {} ??? To think
  var obj = {};

  for (var i = 0; i < array.length; i++){

    var point = array[i];
    var keyValue = point[key];
    if (!obj[keyValue]){
      obj[keyValue] = [];
    }
    obj[keyValue].push(point);
  }

  return obj;

}

function getUniqueArtistInvestors(artists, songs){

  var gameDatasource       = "tradiio_game";
  var analyticsDatasource  = "tradiio_analytics";

  var investmentSongsQuery = "select distinct(song_id) from nysa.api.events.invest.count group by user_id";

  investmentSongsQuery = investmentSongsQuery.sort(function (a, b){ return b.count - a.count;});



}

require(['../config.js'], function(Settings){

  var gameDatasource       = "tradiio_game";
  var analyticsDatasource  = "tradiio_analytics";

  var profitsPosQuery      = "select count(user_id) from nysa.api.users.profit.count where profit >  20 group by user_id, time(1h)";
  var profitsNegQuery      = "select count(user_id) from nysa.api.users.profit.count where profit < -20 group by user_id, time(1h)";
  var songsQuery           = "select song_id, artist_id from nysa.api.songs.valid.count";
  var artistsQuery         = "select * from nysa.api.artists.valid.count";


  var songs   = getInfluxDbData(songsQuery, analyticsDatasource, Settings);
  var artists = getArtistArray(songs);

  var uniqueArtistInvestors = getUniqueArtistInvestors(artists, songs);

  var profitsPosUsers = getInfluxDbData(profitsPosQuery, gameDatasource, Settings);
  var profitsNegUsers = getInfluxDbData(profitsNegQuery, gameDatasource, Settings);

  profitsPosUsers = profitsPosUsers.sort(function (a, b){ return b.count   - a.count;});

  profitsPosUsers = profitsPosUsers.filter(function (value) {
    return value.count > 2;
  });

  console.log(profitsPosUsers);

});

</script>

</body>
</html>
